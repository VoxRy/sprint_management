<?xml version="1.0" encoding="utf-8"?>
<odoo>

  <!-- =========================================================
       TASK FORM (inherit core)
       ========================================================= -->
  <record id="view_task_form_sprint" model="ir.ui.view">
    <field name="name">project.task.form.sprint</field>
    <field name="model">project.task</field>
    <field name="inherit_id" ref="project.view_task_form2"/>
    <field name="priority">99</field>
    <field name="arch" type="xml">

      <!-- Helper field must exist in view -->
      <xpath expr="//sheet" position="before">
        <field name="use_sprint_management" invisible="1"/>
      </xpath>

      <!-- JIRA-LIKE SPRINT INFO BANNER -->
      <xpath expr="//div[contains(@class,'oe_title')]" position="after">
        <div class="alert alert-info o_form_sheet_bg mb-3"
             role="alert"
             attrs="{'invisible':[('sprint_id','=',False)]}">
          <div class="d-flex align-items-center">
            <i class="fa fa-columns fa-2x mr-3 text-info"/>
            <div class="flex-grow-1">
              <strong class="d-block">Current Sprint:</strong>
              <field name="sprint_id"
                     readonly="1"
                     class="oe_inline font-weight-bold"/>

              <span attrs="{'invisible':[('previous_sprint_id','=',False)]}"
                    class="ml-3 text-muted">
                <i class="fa fa-arrow-left"/> Moved from
                <field name="previous_sprint_id" readonly="1" class="oe_inline"/>
              </span>
            </div>
          </div>
        </div>
      </xpath>

      <!-- ✅ Sprint & Epic fields UNDER project area (sol grup içine) -->
      <xpath expr="//sheet/group/group[1]" position="inside">

        <field name="sprint_id"
               string="Sprint"
               attrs="{'invisible':[('use_sprint_management','=',False)]}"
               domain="[('project_id', '=', project_id), ('state', 'in', ['waiting','active'])]"
               options="{'no_create': True, 'no_open': False}"
               placeholder="Select sprint..."
               help="Assign this task to a sprint"/>

        <field name="epic_id"
               string="Epic"
               attrs="{'invisible':[('use_sprint_management','=',False)]}"
               domain="[('project_id', '=', project_id)]"
               options="{'no_create': True, 'no_open': False}"
               placeholder="Select epic..."
               help="Group related tasks under an epic"/>

      </xpath>

    </field>
  </record>


  <!-- =========================================================
       BACKLOG TREE VIEW
       ========================================================= -->
  <record id="view_task_tree_backlog" model="ir.ui.view">
    <field name="name">project.task.tree.backlog</field>
    <field name="model">project.task</field>
    <field name="priority">20</field>
    <field name="arch" type="xml">
      <tree 
            string="Backlog"
            create="true"
            decoration-danger="priority == '1'"
            decoration-warning="priority == '2'"
            decoration-info="kanban_state == 'blocked'">

        <field name="company_id" invisible="1"/>
        <field name="kanban_state" invisible="1"/>
        <field name="use_sprint_management" invisible="1"/>

        <field name="priority" widget="priority" nolabel="1" optional="show"/>
        <field name="name" placeholder="Task name..." required="1"/>
        <field name="project_id" options="{'no_create': True}" optional="show"/>
        <field name="sprint_id" options="{'no_create': True}" placeholder="Assign to sprint..." optional="show"/>
        <field name="epic_id" options="{'no_create': True}" placeholder="Add to epic..." optional="show"/>
        <field name="stage_id" optional="show"/>

        <field name="user_ids"
               widget="many2many_tags"
               options="{'color_field': 'color', 'no_create': True}"
               placeholder="Assign to..."
               optional="show"/>

        <field name="tag_ids"
               widget="many2many_tags"
               options="{'color_field': 'color'}"
               placeholder="Add tags..."
               optional="hide"/>

        <field name="date_deadline" optional="hide"/>
        <field name="activity_ids" widget="list_activity" optional="show"/>

      </tree>
    </field>
  </record>


  <!-- =========================================================
       SPRINT BOARD KANBAN (CORE KANBAN INHERIT - looks like Odoo)
       ========================================================= -->
  <record id="view_task_kanban_sprint_board" model="ir.ui.view">
    <field name="name">project.task.kanban.sprint.board</field>
    <field name="model">project.task</field>

    <!-- ✅ inherit core kanban instead of rewriting -->
    <field name="inherit_id" ref="project.view_task_kanban"/>
    <field name="priority">99</field>

    <field name="arch" type="xml">

      <!-- Ensure fields exist in kanban recordset -->
      <xpath expr="//kanban" position="inside">
        <field name="sprint_id"/>
        <field name="epic_id"/>
      </xpath>

      <!-- ✅ Put badge into core card body -->
      <xpath expr="//div[contains(@class,'o_kanban_record_body')]" position="inside">
        <div class="mt-1 mb-2">
          <t t-if="record.sprint_id.value">
            <span class="badge badge-pill badge-secondary">
              <i class="fa fa-columns"/> <field name="sprint_id"/>
            </span>
          </t>
          <t t-else="">
            <span class="badge badge-pill badge-warning">
              <i class="fa fa-list-ul"/> Backlog
            </span>
          </t>
        </div>

        <div t-if="record.epic_id.value" class="mb-2">
          <span class="badge badge-pill badge-info">
            <i class="fa fa-flag-o"/> <field name="epic_id"/>
          </span>
        </div>
      </xpath>

    </field>
  </record>


  <!-- =========================================================
       SEARCH VIEW WITH FILTERS (inherit core search)
       ========================================================= -->
  <record id="view_task_search_sprint" model="ir.ui.view">
    <field name="name">project.task.search.sprint</field>
    <field name="model">project.task</field>
    <field name="inherit_id" ref="project.view_task_search_form"/>
    <field name="arch" type="xml">

      <!-- Search Panel -->
      <xpath expr="//search" position="inside">
        <searchpanel>
          <field name="sprint_id" icon="fa-columns" enable_counters="1" select="multi"/>
          <field name="epic_id" icon="fa-flag" enable_counters="1" select="multi"/>
          <field name="stage_id" icon="fa-tasks" enable_counters="1"/>
          <field name="user_ids" icon="fa-user" enable_counters="1" select="multi"/>
        </searchpanel>
      </xpath>

      <!-- Extra search fields -->
      <xpath expr="//field[@name='name']" position="after">
        <field name="sprint_id" string="Sprint" filter_domain="[('sprint_id', 'ilike', self)]"/>
        <field name="epic_id" string="Epic" filter_domain="[('epic_id', 'ilike', self)]"/>
        <field name="stage_id" string="Stage" filter_domain="[('stage_id', 'ilike', self)]"/>
        <field name="tag_ids" string="Tags" filter_domain="[('tag_ids', 'ilike', self)]"/>
      </xpath>

      <!-- Filters -->
      <xpath expr="//filter[@name='my_tasks']" position="after">
        <separator/>
        <filter string="Backlog Tasks" name="filter_backlog" domain="[('sprint_id','=',False)]"/>
        <filter string="Active Sprint" name="filter_active_sprint" domain="[('sprint_id.state','=','active')]"/>
        <filter string="Has Epic" name="filter_has_epic" domain="[('epic_id','!=',False)]"/>
        <separator/>
        <filter string="Blocked" name="filter_blocked" domain="[('kanban_state','=','blocked')]"/>
        <filter string="High Priority" name="filter_high_priority" domain="[('priority','in',['1','2'])]"/>
      </xpath>

      <!-- Group By -->
      <xpath expr="//filter[@name='project']" position="after">
        <filter string="Sprint" name="group_sprint" context="{'group_by':'sprint_id'}"/>
        <filter string="Epic" name="group_epic" context="{'group_by':'epic_id'}"/>
        <filter string="Stage" name="group_stage" context="{'group_by':'stage_id'}"/>
        <filter string="Assigned To" name="group_user" context="{'group_by':'user_ids'}"/>
        <filter string="Priority" name="group_priority" context="{'group_by':'priority'}"/>
      </xpath>

    </field>
  </record>


  <!-- =========================================================
       BULK MOVE TO SPRINT WIZARD ACTION
       ========================================================= -->
  <record id="action_sprint_move_wizard" model="ir.actions.act_window">
    <field name="name">Move to Sprint</field>
    <field name="res_model">sprint.move.wizard</field>
    <field name="view_mode">form</field>
    <field name="target">new</field>
    <field name="binding_model_id" ref="project.model_project_task"/>
    <field name="binding_view_types">list</field>
  </record>

</odoo>
